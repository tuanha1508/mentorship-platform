<!-- Search Mentor Page - Visible only when mentee has no assigned mentor -->
<div class="search-mentor-page">
    <!-- Row 1: Search Input -->
    <div class="row search-row">
        <div class="search-panel">
            <div class="search-input-group">
                <input type="text" class="search-input" placeholder="Search by name, skills, or expertise...">
                <button class="btn-primary">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Search Filter -->
    <div class="row filter-row">
        <div class="filter-panel">
            <div class="filter-container">
                <div class="filter-item active">
                    <i class="fas fa-globe"></i> All
                </div>
                <div class="filter-item">
                    <i class="fas fa-code"></i> Web Development
                </div>
                <div class="filter-item">
                    <i class="fas fa-mobile-alt"></i> Mobile Development
                </div>
                <div class="filter-item">
                    <i class="fas fa-database"></i> Data Science
                </div>
                <div class="filter-item">
                    <i class="fas fa-sitemap"></i> Machine Learning
                </div>
                <div class="filter-item">
                    <i class="fas fa-laptop-code"></i> Software Engineering
                </div>
                <div class="filter-item">
                    <i class="fas fa-paint-brush"></i> UI/UX Design
                </div>
                <div class="filter-item">
                    <i class="fas fa-shield-alt"></i> Cybersecurity
                </div>
                <div class="filter-item">
                    <i class="fas fa-cloud"></i> Cloud Computing
                </div>
                <div class="filter-item">
                    <i class="fas fa-robot"></i> Artificial Intelligence
                </div>
                <div class="filter-item">
                    <i class="fas fa-project-diagram"></i> DevOps
                </div>
                <div class="filter-item">
                    <i class="fas fa-chart-line"></i> Product Management
                </div>
                <div class="filter-item">
                    <i class="fas fa-bug"></i> QA Testing
                </div>
                <div class="filter-item">
                    <i class="fas fa-gamepad"></i> Game Development
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 3: Mentor Cards -->
    <div class="row mentor-row">
        <div class="mentor-grid-container">
            <div class="mentor-grid" id="mentor-results">
                    <!-- Mentor Card 1 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor1.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">Dr. Jane Smith</h4>
                            <div class="mentor-title">Senior Software Engineer<br>Tech Solutions Inc.</div>
                            <div class="mentor-skills">
                                <span class="skill-tag">JavaScript</span>
                                <span class="skill-tag">React</span>
                                <span class="skill-tag">Node.js</span>
                                <span class="skill-tag">Database</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">12</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">24</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.9</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
                    
                    <!-- Mentor Card 2 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor2.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">Michael Chen</h4>
                            <div class="mentor-title">Frontend Lead<br>DevCorp</div>
                            <div class="mentor-skills">
                                <span class="skill-tag">HTML/CSS</span>
                                <span class="skill-tag">JavaScript</span>
                                <span class="skill-tag">Vue.js</span>
                                <span class="skill-tag">UI/UX</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">8</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">18</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.7</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
                    
                    <!-- Mentor Card 3 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor3.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">Sarah Johnson</h4>
                            <div class="mentor-title">Data Scientist<br>DataAnalytica</div>
                            <div class="mentor-skills">
                                <span class="skill-tag">Python</span>
                                <span class="skill-tag">Machine Learning</span>
                                <span class="skill-tag">Data Analysis</span>
                                <span class="skill-tag">SQL</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">6</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">12</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.8</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
                    
                    <!-- Mentor Card 4 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor4.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">James Wilson</h4>
                            <div class="mentor-title">Backend Engineer<br>CloudBase</div>
                            <div class="mentor-skills">
                                <span class="skill-tag">Java</span>
                                <span class="skill-tag">Spring</span>
                                <span class="skill-tag">Microservices</span>
                                <span class="skill-tag">AWS</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">10</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">15</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.6</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
                    
                    <!-- Mentor Card 5 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor5.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">Emily Rodriguez</h4>
                            <div class="mentor-title">UX Designer<br>DesignHub</div>
                            <div class="mentor-skills">
                                <span class="skill-tag">UI/UX</span>
                                <span class="skill-tag">Figma</span>
                                <span class="skill-tag">Sketch</span>
                                <span class="skill-tag">User Research</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">7</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">20</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.9</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
                    
                    <!-- Mentor Card 6 -->
                    <div class="mentor-profile-box">
                        <div class="mentor-header">
                            <img src="../images/mentor6.jpg" alt="Mentor" class="mentor-img">
                            <h4 class="mentor-name">David Taylor</h4>
                            <p class="mentor-title">Mobile Developer at AppWorks</p>
                            <div class="mentor-skills">
                                <span class="skill-tag">Flutter</span>
                                <span class="skill-tag">React Native</span>
                                <span class="skill-tag">iOS</span>
                                <span class="skill-tag">Android</span>
                            </div>
                        </div>
                        <div class="mentor-stats">
                            <div class="mentor-stat">
                                <div class="stat-number">5</div>
                                <div class="stat-text">Years Exp.</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">9</div>
                                <div class="stat-text">Mentees</div>
                            </div>
                            <div class="mentor-stat">
                                <div class="stat-number">4.5</div>
                                <div class="stat-text">Rating</div>
                            </div>
                        </div>
                        <div class="mentor-actions">
                            <button class="btn-view-profile">View Profile</button>
                            <button class="btn-connect">Connect</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
    
    <!-- Template for mentor card (hidden, used by JavaScript) -->
    <template id="mentor-card-template">
        <div class="mentor-profile-box">
            <div class="mentor-header">
                <img src="" alt="Mentor" class="mentor-img">
                <h4 class="mentor-name"></h4>
                <div class="mentor-title"></div>
                <div class="mentor-skills"></div>
            </div>
            <div class="mentor-stats">
                <div class="mentor-stat">
                    <div class="stat-number"></div>
                    <div class="stat-text">Years Exp.</div>
                </div>
                <div class="mentor-stat">
                    <div class="stat-number"></div>
                    <div class="stat-text">Mentees</div>
                </div>
                <div class="mentor-stat">
                    <div class="stat-number"></div>
                    <div class="stat-text">Rating</div>
                </div>
            </div>
            <div class="mentor-actions">
                <button class="btn-connect">Connect</button>
                <button class="btn-view-profile">View Profile</button>
            </div>
        </div>
    </template>
</div>

<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize connect buttons
        initConnectButtons();
    });

    // Initialize all connect buttons on the search-mentor page
    function initConnectButtons() {
        console.log('Initializing connect buttons');
        const connectButtons = document.querySelectorAll('.btn-connect');
        console.log('Found connect buttons:', connectButtons.length);
        
        // Get current mentee information from localStorage
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const menteeName = userData.fullName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
        
        // First check existing connection requests and update button states
        connectButtons.forEach(button => {
            // Find the mentor card that contains this button
            const mentorCard = button.closest('.mentor-profile-box');
            if (!mentorCard) return;
            
            // Get mentor name from the card
            const mentorName = mentorCard.querySelector('.mentor-name').textContent;
            
            // Check if a request already exists for this mentor
            checkExistingRequest(mentorName, menteeName, button);
            
            // Add click event listener
            button.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Connect button clicked for:', mentorName);
                
                // Get mentor information from the card
                const mentorImg = mentorCard.querySelector('.mentor-img').src;
                
                // Create a connection request
                sendConnectionRequest(mentorName, mentorImg, menteeName, this);
            });
        });
    }
    
    // Check if a request already exists for this mentor and update button state
    function checkExistingRequest(mentorName, menteeName, buttonElement) {
        // Check for request in mentor's localStorage entry
        try {
            const mentorData = localStorage.getItem(mentorName) ? 
                JSON.parse(localStorage.getItem(mentorName)) : null;
            
            if (mentorData && mentorData.requests && Array.isArray(mentorData.requests)) {
                // Check if this mentee already sent a pending or accepted request to this mentor
                const existingRequest = mentorData.requests.find(request => 
                    request.menteeName === menteeName && 
                    (request.status === 'pending' || request.status === 'accepted')
                );
                
                if (existingRequest) {
                    // Update button to show request already sent
                    buttonElement.textContent = 'Request Sent';
                    buttonElement.disabled = true;
                    buttonElement.classList.add('request-sent');
                }
            }
        } catch (error) {
            console.error(`Error checking existing request for ${mentorName}:`, error);
        }
        
        // Also check the connection service data
        if (window.connectionService) {
            try {
                const storedRequests = localStorage.getItem('connectionRequests');
                if (storedRequests) {
                    const requests = JSON.parse(storedRequests);
                    
                    // Get the user data again since it's not available from parent scope
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    
                    // Generate IDs like we do when sending requests
                    const menteeId = userData.id || 'user123';
                    const mentorId = mentorName.replace(/\s+/g, '_').toLowerCase();
                    
                    // Check if this mentee already sent a pending or accepted request to this mentor
                    const existingRequest = requests.find(req => 
                        req.menteeId === menteeId && 
                        req.mentorId === mentorId && 
                        (req.status === 'pending' || req.status === 'accepted')
                    );
                    
                    if (existingRequest) {
                        // Update button to show request already sent
                        buttonElement.textContent = 'Request Sent';
                        buttonElement.disabled = true;
                        buttonElement.classList.add('request-sent');
                    }
                }
            } catch (error) {
                console.error('Error checking connectionService requests:', error);
            }
        }
    }

    // Send a connection request to a mentor
    function sendConnectionRequest(mentorName, mentorImg, menteeName, buttonElement) {
        console.log('sendConnectionRequest called with:', { mentorName, menteeName });
        // Get any existing mentor data from localStorage
        const mentorData = localStorage.getItem(mentorName) ? 
            JSON.parse(localStorage.getItem(mentorName)) : {};
        
        // Update mentor data with the request
        mentorData.requests = mentorData.requests || [];
        
        // Check if this mentee already sent a request to this mentor that is still pending or accepted
        const existingRequest = mentorData.requests.find(request => 
            request.menteeName === menteeName && 
            (request.status === 'pending' || request.status === 'accepted')
        );
        
        if (existingRequest) {
            showRequestFeedback('info', `You already sent a request to ${mentorName}.`);
            return;
        }
        
        // Check if there was a rejected request
        const rejectedRequest = mentorData.requests.find(request => 
            request.menteeName === menteeName && 
            request.status === 'rejected'
        );
        
        if (rejectedRequest) {
            console.log('Previous request was rejected. Allowing to send a new one.');
            // Remove the old rejected request so we can create a new one
            mentorData.requests = mentorData.requests.filter(request => 
                !(request.menteeName === menteeName && request.status === 'rejected')
            );
        }
        
        // Add the new request
        mentorData.requests.push({
            menteeName: menteeName,
            timestamp: new Date().toISOString(),
            status: 'pending'
        });
        
        // Save updated mentor data back to localStorage
        localStorage.setItem(mentorName, JSON.stringify(mentorData));
        
        // Also update via the connection service if available
        if (window.connectionService) {
            // Get user data for IDs
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const menteeId = userData.id || 'user123'; // Fallback ID
            const mentorId = mentorName.replace(/\s+/g, '_').toLowerCase(); // Generate an ID from name
            
            // Send request via connection service
            window.connectionService.sendConnectionRequest(
                menteeId, 
                mentorId, 
                `I would like to connect with you as my mentor.`
            );
        }
        
        // Show success feedback
        console.log('About to show request feedback');
        showRequestFeedback('success', `Request sent to ${mentorName}!`);
        console.log('Feedback should be displayed now');
        
        // Update button style to show request sent
        buttonElement.textContent = 'Request Sent';
        buttonElement.disabled = true;
        buttonElement.classList.add('request-sent');
    }

    // Show feedback message to the user
    function showRequestFeedback(type, message) {
        console.log('showRequestFeedback called with:', { type, message });
        // Create feedback element if it doesn't exist
        let feedbackEl = document.getElementById('request-feedback');
        if (!feedbackEl) {
            feedbackEl = document.createElement('div');
            feedbackEl.id = 'request-feedback';
            feedbackEl.style.position = 'fixed';
            feedbackEl.style.top = '20px';
            feedbackEl.style.right = '20px';
            feedbackEl.style.padding = '12px 20px';
            feedbackEl.style.borderRadius = '4px';
            feedbackEl.style.color = 'white';
            feedbackEl.style.fontWeight = 'bold';
            feedbackEl.style.zIndex = '9999';
            feedbackEl.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            document.body.appendChild(feedbackEl);
        }
        
        // Set feedback content and type
        feedbackEl.textContent = message;
        
        // Set color based on type
        if (type === 'success') {
            feedbackEl.style.backgroundColor = '#28a745';
        } else if (type === 'error') {
            feedbackEl.style.backgroundColor = '#dc3545';
        } else if (type === 'info') {
            feedbackEl.style.backgroundColor = '#17a2b8';
        }
        
        // Show the feedback
        feedbackEl.style.display = 'block';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, 3000);
    }
</script>
